<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Rеţele de calculatoare</title>
        <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>
        <!-- bootstrap 3.0.2 -->
        <link href="../css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <!-- font Awesome -->
        <link href="../css/font-awesome.min.css" rel="stylesheet" type="text/css" />
        <!-- Ionicons -->
        <link href="../css/ionicons.min.css" rel="stylesheet" type="text/css" />
        <!-- Ion Slider -->
        <link href="../css/ionslider/ion.rangeSlider.css" rel="stylesheet" type="text/css" />
        <!-- ion slider Nice -->
        <link href="../css/ionslider/ion.rangeSlider.skinNice.css" rel="stylesheet" type="text/css" />
        <!-- Theme style -->
        <link href="../css/AdminLTE.css" rel="stylesheet" type="text/css" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="../js/html5shiv.js"></script>
          <script src="../js/respond.min.js"></script>
        <![endif]-->
        <style>
            #lambdaTable, #lambdaTable tbody, #lambdaTable tbody tr,
            #time, #time tbody, #time tbody tr  {
                width:  100%;
            }
            #lambdaTable tbody tr td,
            #time tbody tr td {
                text-align: center;
            }
            #lambdaTable input,
            #time input{
                width: 100%;
                min-width: 79px;
            }
            .none {
                display: none;
            }
            .highlighter {
                display: block;
                background-color: white;
                padding: 10px;
                position: relative;
                font-size: 15px;
                z-index: 999;
                text-align: center;
            }

            table.result {
                margin-top: 20px;
            }

            table.result tr td {
                border: 1px solid lightgray;
                padding: 8px;
            }
            table.result tr td.error {
                font-weight: bold;
                color: red;
            }

        </style>
    </head>
    <body class="skin-blue">
        <!-- header logo: style can be found in header.less -->
        <header class="header">
            <a href="../index.html" class="logo">
                <!-- Add the class icon to your logo image or logo icon to add the margining -->
                <small> Retele de calculatoare </small>
            </a>
            <!-- Header Navbar: style can be found in header.less -->
            <nav class="navbar navbar-static-top" role="navigation">
                <!-- Sidebar toggle button-->
                <a href="#" class="navbar-btn sidebar-toggle" data-toggle="offcanvas" role="button">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </a>
                <div class="navbar-right">
                    <ul class="nav navbar-nav">
                    </ul>
                </div>
            </nav>
        </header>
        <div class="wrapper row-offcanvas row-offcanvas-left">
            <!-- Left side column. contains the logo and sidebar -->
            <aside class="left-side sidebar-offcanvas">
                <!-- sidebar: style can be found in sidebar.less -->
                <section class="sidebar">
                    <!-- Sidebar user panel -->
                    <div class="user-panel text-center">
                        <div class="pull-right">
                            <img src="../img/faf_logo.png" alt="User Image" style="width: 100%;" />
                        </div>
                    </div>
                    <!-- sidebar menu: : style can be found in sidebar.less -->
                    <ul class="sidebar-menu">
                        <li>
                            <a href="../index.html">
                                <i class="fa fa-archive"></i> <span>Pagina principala</span>
                            </a>
                        </li>
                        <li class="active">
                            <a href="lab8.html">
                                <i class="fa fa-th"></i> <span>Laborator 8</span>
                            </a>
                            <ul class="treeview-menu" style="display: block;">
                                <li class="active"><a href="lab8.html" style="margin-left: 10px;"><i class="fa fa-angle-double-right"></i> 8 a)</a></li>
                                <li><a href="lab8_1.html" style="margin-left: 10px;"><i class="fa fa-angle-double-right"></i> 8 b)</a></li>
                            </ul>
                        </li>
                       <li>
                            <a href="lab9.html">
                                <i class="fa fa-th  "></i> <span>Laborator 9</span>
                            </a>
                        </li>
                        <li>
                            <a href="lab10.html">
                                <i class="fa fa-th"></i> <span>Laborator 10</span>
                            </a>
                        </li>
                        <li>
                            <a href="lab11.html">
                                <i class="fa fa-th"></i> <span>Laborator 11</span>
                            </a>
                        </li>
                    </ul>
                </section>
                <!-- /.sidebar -->
            </aside>

            <!-- Right side column. Contains the navbar and content of the page -->
            <aside class="right-side">
                <!-- Content Header (Page header) -->
                <section class="content-header">
                    <h1>
                        Determinarea capacităţii canalelor de transfer date ale reţelelor
                    </h1>
                </section>

                <!-- Main content -->
                <section class="content">

                    <div id="nrCanale"></div>
                    Numărul de etape: <input style="width: 150px; margin: 4px;" type="number" value="2" id="nrEtape" min="2" max="3"/>
                    <div id="volBiti"></div>
                    <div id="leiBit"></div>
                    <table id="time"></table>
                    <table id="lambdaTable">

                    </table>

                    <button style="margin: 7px 15px;" class="btn btn-success calc">Calculate</button>
                    <div class="results"></div>
                </section><!-- /.content -->
            </aside><!-- /.right-side -->
        </div><!-- ./wrapper -->

        <!-- jQuery 2.0.2 -->
        <script src="../js/jquery.min.js"></script>
        <!-- jQuery UI 1.10.3 -->
        <script src="../js/jquery-ui-1.10.3.min.js" type="text/javascript"></script>
        <!-- Bootstrap -->
        <script src="../js/bootstrap.min.js" type="text/javascript"></script>
        <!-- iCheck -->
        <script src="../js/plugins/iCheck/icheck.min.js" type="text/javascript"></script>
        <!-- AdminLTE App -->
        <script src="../js/AdminLTE/app.js" type="text/javascript"></script>
        <!-- Ion Slider -->
        <script src="../js/plugins/ionslider/ion.rangeSlider.min.js" type="text/javascript"></script>

        <script type="text/javascript">
            $(function() {

                var problem = new (function(){
                    var lambda   = [];
                    var channels = 10;
                    var bits     = 500;
                    var etape    = 2;
                    var gamma    = 0;
                    var time     = 1;
                    var costs    = [];
                    var minCost  = 0.000001;
                    var maxCost  = 0.00001;
                    var d        = [];
                    var produses = [];

                    this.setBits = function(value){
                        bits = value;
                    }

                    this.getBits = function(){
                        return bits;
                    }

                    this.setChannels = function(value){
                        channels = parseInt(value);
                    }

                    this.getChannels = function(){
                        return channels;
                    }

                    this.setCost = function(index, value, printer){
                        printer      = !printer
                        index        = parseInt(index) - 1
                        costs[index] = parseFloat(value)
                        costs[index] = costs[index] < minCost ? minCost : costs[index] > maxCost ? maxCost : costs[index];

                        produses[index] = costs[index] * ( lambda[index] || 0 ) * ( bits || 0 );

                        if( printer )
                            console.log( costs[index] +' cost was set at id: '+ index )
                    }

                    // this.setCost = function(index, value){
                    //     cost = parseFloat(value) - 1;
                    //     cost = cost < minCost ? minCost : cost > maxCost ? maxCost : cost;
                    // }

                    this.setCosts = function(values){
                        var self = this;
                        costs = [];
                        $.each(values, function(index, val) {
                            self.setCost(index + 1, val, true);
                        });
                    }


                    this.getCost = function(){
                        return cost;
                    }

                    this.setEtape = function(value){
                        etape = value;
                        this.calcGamma();
                    }

                    this.setLambdas = function(values){
                        var self = this;
                        lambda = [];
                        $.each(values, function(index, val) {
                            self.setLambda(index + 1, val, true);
                        });

                        this.calcGamma()
                    }

                    this.setLambda = function(index, value, calcGamma){
                        calcGamma     = !calcGamma
                        index         = parseInt(index) - 1
                        lambda[index] = parseInt(value);

                        produses[index] = ( costs[index] || 0 ) * lambda[index] * ( bits || 0 );

                        if( !calcGamma )
                            return

                        console.log('Lambda: '+ value +' was set on id: '+index);
                        this.calcGamma();
                    }

                    this.setTime = function(value){
                        time = parseInt(value);
                    }

                    this.getTime = function(){
                        return time;
                    }

                    this.calcGamma = function(){
                        sum   = lambda.reduce(function(a,b){ return a + b}, 0);
                        console.log('Sum of lambdas = ' + sum)
                        gamma = sum * (1 / etape)
                        console.log('gamma = '+ sum +' * ( 1 / '+ etape +' ) = '+ gamma);
                    }

                    this.calculate = function(){
                        var times = $('.time').map(function(i, a){
                            var val = $(a).val();
                            return val || (val + '').length ? parseFloat(val) : -1
                        })

                        // console.log(times)
                        // console.log(bits)
                        // console.log(lambda)
                        // console.log(costs)
                        // console.log(time)

                        $('.results').html('');
                        d = []

                        var sum1 = 0
                        var sum2 = 0
                        var results = []
                        var Ctotal = [];

                        for( i = 0; i < channels; i++)
                        {
                            var prod = costs[i] * lambda[i] * bits
                            sum1 += Math.sqrt(prod)
                            sum2 += prod
                        }

                        for(var timeId = 0; timeId < times.length; timeId++){

                            d[0] = d[0] || $('<tr>').append('<td>')
                            d[0].append('<td>C*_'+ (timeId+1) + '</td>');

                            var time = times[timeId]
                            var tmp  = []
                            for( i = 0; i < channels; i++)
                            {
                                tmp[i] = lambda[i] * bits + ( Math.sqrt(costs[i]*lambda[i]*bits) / ( costs[i] * sum1 ) ) * ( time - sum2 )
                                d[i+1] = d[i+1] || $('<tr>').append('<td>d_'+ (i+1) + '</td>');
                                if( tmp[i] >= 0)
                                    d[i+1].append('<td>'+ tmp[i].toFixed(2) +'</td>');
                                else
                                    d[i+1].append('<td class="error" title="C - este greșit">'+ 'N/A' +'</td>');

                                Ctotal[timeId] = Ctotal[timeId] || 0;
                                Ctotal[timeId] += (lambda[i] * bits) / ( tmp[i] - ( lambda[i] * bits ) );
                            }
                            Ctotal[timeId] /= gamma
                            results[timeId] = tmp.reduce(function(a,b){ return a+b },0) / channels


                            d[i+1] = d[i+1] || $('<tr>').append('<td>T*</td>');
                            d[i+1].append('<td>'+ Ctotal[timeId].toFixed(5) + '</td>');
                            // if( d[timeId] >= 0)
                            //     $('.results').append('d'+(timeId+1)+') ' + d[timeId].toFixed(2) + '<br>')
                            // else
                            //     $('.results').append('<span style="color: red;">d'+(timeId+1)+') ' + 'N/A - careva date pentru C*_'+ timeId + ' nu sunt în regulă. </span><br>')
                        }

                        var $table = $('<table class="result">')
                        $('.results').html('').append($table);
                        for( var i in d ){
                            $row = d[i]
                            $table.append($row)
                        }

                        var options = {
                            series: {
                                lines: { show: true },
                                points: { show: true }
                            }
                        };
                    }

                    this.print = function(){
                        var data = {
                            'lambda': lambda
                            , 'channels': channels
                            , 'bits': bits
                            , 'etape': etape
                            , 'gamma': gamma
                            , 'time': time
                            , 'costs': costs
                            , 'minCost': minCost
                            , 'maxCost': maxCost
                        }
                        console.log(data)
                    }

                })()

                function addTime(){
                    var $div = $('#time');
                    var $row = $('<tr class="time_row">');
                    $row.append($('<td>').text('C*'))
                    for( var i = 0; i < 10; i++ ){
                        console.log(i)
                        var $td = $('<td class="time_td_'+i+'">');
                        var $input = $('<input>').addClass('time').attr('type', 'number')
                        $row.append($td.append($input));
                    }
                    $div.append($row);
                };
                addTime()

                function addLambdaRows(value){

                    var $row1 = $('.row_1');
                    if( !$row1.length )
                    {
                        $row1 = $('<tr class="row_1">')
                        $row1.append('<td></td>')
                    }
                    var $row2 = $('.row_2');
                    if( !$row2.length ){
                        $row2 = $('<tr class="row_2">')
                        $row2.append($('<td>').html("&lambda;"))
                    }
                    var $row3 = $('.row_3');
                    if( !$row3.length )
                    {
                        $row3 = $('<tr class="row_3">')
                        $row3.append($('<td>').html("k<small>i</small>"))
                    }

                    var $last = $('.lambda_input').last();
                    if( $last.length ) {
                        i = parseInt( $last.attr('data-id') ) + 1;
                        if( i > value ) {
                            $('.lambda_'+value+' ~ td').remove()
                            $('.cost_'+value+' ~ td').remove()
                            $('.col_'+value+' ~ td').remove()
                        }
                    }
                    else
                        i = 1
                    for( i = i ; i <= value; i++ )
                    {
                        $lambdaInput = $('<input>').attr('type', 'number')
                                                .val(10).addClass('lambda_input')
                                                .attr({'min': 10, 'max': 50, 'data-id': i})
                        $costInput   = $('<input>').attr('type', 'number')
                                                .val(0.000001).addClass('cost_input')
                                                .attr({'min': 0.000001, 'max': 0.00001, 'step': 0.0000001, 'data-id': i})
                        var $lambda = $('<td class="lambda_'+i+'"></td>')
                        var $cost   = $('<td class="cost_'+i+'"></td>')

                        $lambda.append($lambdaInput)
                        $cost.append($costInput)

                        $lambdaInput.on('change', function(e){
                            var $target = $(e.target)
                            var id      = $target.attr('data-id')
                            problem.setLambda(id, $target.val())
                        });

                        $costInput.on('change', function(e){
                            var $target = $(e.target)
                            var id      = $target.attr('data-id')
                            problem.setCost(id, $target.val())
                        });

                        $row2.append($lambda);
                        $row3.append($cost);
                        $row1.append('<td class="col_'+i+'">'+i+'</td>');
                    }
                    $('#lambdaTable').append($row1, $row2, $row3);
                }

                /* ION SLIDER */
                $("#nrCanale").ionRangeSlider({
                    min: 0,
                    max: 20,
                    type: 'single',
                    step: 1,
                    postfix: " Canale",
                    prettify: true,
                    hasGrid: false,
                    onFinish: function(value){
                        problem.setChannels(value.fromNumber)
                        addLambdaRows(value.fromNumber)
                        var $lambdaInputs = $('.lambda_input').map(function(a, b){ return $(b).val(); })
                        var $costInputs   = $('.cost_input').map(function(a, b){ return $(b).val(); })
                        problem.setLambdas($lambdaInputs)
                        problem.setCosts($costInputs)
                        $('#nrEtape').attr('max', Math.floor(problem.getChannels()/3));
                    },
                    onLoad: function(value){
                        addLambdaRows(value.fromNumber)

                        var $lambdaInputs = $('.lambda_input').map(function(a, b){ return $(b).val(); })
                        var $costInputs   = $('.cost_input').map(function(a, b){ return $(b).val(); })
                        problem.setLambdas($lambdaInputs)
                        problem.setCosts($costInputs)
                    }
                });
                $("#volBiti").ionRangeSlider({
                    min: 500,
                    max: 5000,
                    type: 'single',
                    step: 1,
                    prefix: "V - ",
                    postfix: " Biți",
                    prettify: true,
                    hasGrid: false,
                    onFinish: function(value){
                        problem.setBits(value.fromNumber)
                    }
                });

                // $("#time").ionRangeSlider({
                //     min: 1,
                //     max: 10,
                //     type: 'single',
                //     step: 1,
                //     postfix: " Hertz",
                //     prettify: true,
                //     hasGrid: false,
                //     onFinish: function(value){
                //         problem.setTime(value.fromNumber)
                //     },

                //     onLoad: function(val){
                //     }
                // });

                $('.btn.calc').on('click', function(){
                    problem.print();
                    problem.calculate()
                });

                $('#nrEtape').on('change', function(e){
                    problem.setEtape(e.target.value)
                })

            });
        </script>

    </body>
</html>
