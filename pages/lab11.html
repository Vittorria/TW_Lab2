<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Rеţele de calculatoare</title>
        <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>
        <!-- bootstrap 3.0.2 -->
        <link href="../css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <!-- font Awesome -->
        <link href="../css/font-awesome.min.css" rel="stylesheet" type="text/css" />
        <!-- Ionicons -->
        <link href="../css/ionicons.min.css" rel="stylesheet" type="text/css" />
        <!-- Ion Slider -->
        <link href="../css/ionslider/ion.rangeSlider.css" rel="stylesheet" type="text/css" />
        <!-- ion slider Nice -->
        <link href="../css/ionslider/ion.rangeSlider.skinNice.css" rel="stylesheet" type="text/css" />
        <!-- Theme style -->
        <link href="../css/AdminLTE.css" rel="stylesheet" type="text/css" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="../js/html5shiv.js"></script>
          <script src="../js/respond.min.js"></script>
        <![endif]-->
    </head>
    <body class="skin-blue">
        <!-- header logo: style can be found in header.less -->
        <header class="header">
            <a href="../index.html" class="logo">
                <!-- Add the class icon to your logo image or logo icon to add the margining -->
                <small> Retele de calculatoare </small>
            </a>
            <!-- Header Navbar: style can be found in header.less -->
            <nav class="navbar navbar-static-top" role="navigation">
                <!-- Sidebar toggle button-->
                <a href="#" class="navbar-btn sidebar-toggle" data-toggle="offcanvas" role="button">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </a>
                <div class="navbar-right">
                    <ul class="nav navbar-nav">
                    </ul>
                </div>
            </nav>
        </header>
        <div class="wrapper row-offcanvas row-offcanvas-left">
            <!-- Left side column. contains the logo and sidebar -->
            <aside class="left-side sidebar-offcanvas">
                <!-- sidebar: style can be found in sidebar.less -->
                <section class="sidebar">
                    <!-- Sidebar user panel -->
                    <div class="user-panel text-center">
                        <div class="pull-right">
                            <img src="../img/faf_logo.png" alt="User Image" style="width: 100%;" />
                        </div>
                    </div>
                    <!-- sidebar menu: : style can be found in sidebar.less -->
                    <ul class="sidebar-menu">
                        <li>
                            <a href="../index.html">
                                <i class="fa fa-archive"></i> <span>Pagina principala</span>
                            </a>
                        </li>
                        <li>
                            <a href="lab8.html">
                                <i class="fa fa-th"></i> <span>Laborator 8</span>
                            </a>
                        </li>
                       <li>
                            <a href="lab9.html">
                                <i class="fa fa-th"></i> <span>Laborator 9</span>
                            </a>
                        </li>
                        <li>
                            <a href="lab10.html">
                                <i class="fa fa-th"></i> <span>Laborator 10</span>
                            </a>
                        </li>
                        <li class="active">
                            <a href="lab11.html">
                                <i class="fa fa-th"></i> <span>Laborator 11</span>
                            </a>
                        </li>
                    </ul>
                </section>
                <!-- /.sidebar -->
            </aside>

            <!-- Right side column. Contains the navbar and content of the page -->
            <aside class="right-side">
                <!-- Content Header (Page header) -->
                <section class="content-header">
                    <h1>
                        Securitatea datelor în reţele
                        <small>Algoritmul RSA</small>
                    </h1>
                </section>

                <!-- Main content -->
                <section class="content">

                    <div class="row">
                        <!-- left column -->
                        <div class="col-md-6">
                            <!-- general form elements -->
                            <div class="box box-primary">
                                <div class="box-header">
                                    <i class="fa fa-file-text"></i>
                                    <h3 class="box-title">Input / Result</h3>
                                </div><!-- /.box-header -->
                                <!-- form start -->
                                <form role="form">
                                    <div class="box-body">
                                        <!-- textarea -->
                                        <div class="form-group">
                                                <textarea id="input_text" class="form-control" rows="5" placeholder="Introduceti textul dorit ... "></textarea>
                                        </div>
                                          <div class="row">
                                            <!-- left column -->
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <div class="input-group col-xs-12">
                                                        <span class="input-group-addon">Sender Private key</span>
                                                        <input id="a_private_key" type="number" class="form-control"/>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <div class="input-group col-xs-12">
                                                        <span class="input-group-addon">Receiver Public key</span>
                                                        <input id="b_public_key" type="number" class="form-control"/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div><!-- /.box-body -->

                                    <div class="box-footer clearfix">
                                        <div class="pull-right">
                                            <button id="encode" type="submit" class="btn btn-sm btn-warning">
                                                Encode  <i class="fa fa-long-arrow-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div><!-- /.box -->
                        </div><!--/.col (left) -->

                        <!-- right column -->
                        <div class="col-md-6">
                            <!-- general form elements -->
                            <div class="box box-primary">
                                <div class="box-header">
                                    <i class="fa fa-file-text"></i>
                                    <h3 class="box-title">Coded Text</h3>
                                </div><!-- /.box-header -->
                                <!-- form start -->
                                <form role="form">
                                    <div class="box-body">
                                        <!-- textarea -->
                                        <div class="form-group">
                                            <!-- <label>Textarea</label> -->
                                            <textarea id="crypto" class="form-control" rows="5" placeholder="Result primit ... "></textarea>
                                        </div>

                                        <div class="row">
                                            <!-- left column -->
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <div class="input-group col-xs-12">
                                                        <span class="input-group-addon">Sender Public key</span>
                                                        <input id="a_public_key" type="number" class="form-control"/>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <div class="input-group col-xs-12">
                                                        <span class="input-group-addon">Receiver Private key</span>
                                                        <input id="b_private_key" type="number" class="form-control"/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div><!-- /.box-body -->

                                    <div class="box-footer clearfix">
                                        <div class="pull-left">
                                            <button id="decode" type="submit" class="btn btn-sm btn-warning">
                                                <i class="fa fa-long-arrow-left"></i> Decode
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div><!-- /.box -->
                        </div><!--/.col (right) -->
                    </div>   <!-- /.row -->

                    <div class="row">
                        <!-- left column -->
                        <div class="col-md-6">
                            <div class="box box-danger">
                                <div class="box-header">
                                    <h3 class="box-title">Parametri</h3>
                                </div>
                                <div class="box-body">
                                <div class="form-group numbers_form">
                                    <p class="help-block">Introduceti 2 numere prime</p>
                                    <div class="row">
                                        <!-- left column -->
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <div class="input-group col-xs-12">
                                                    <span class="input-group-addon">p</span>
                                                    <input id="p" type="number" class="form-control" placeholder="23"/>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <div class="input-group pull-right col-xs-12">
                                                    <span class="input-group-addon">q</span>
                                                    <input id="q" type="number" class="form-control" placeholder="17">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <div class="input-group pull-right col-xs-12">
                                                    <span class="input-group-addon">r</span>
                                                    <input id="r" type="number" class="form-control" placeholder="">
                                                </div>
                                            </div>
                                        </div>
                                      </div>
                                    </div>
                                </div><!-- /.box-body -->
                            </div><!-- /.box -->
                        </div><!--/.col -->

                        <div class="col-md-6">
                            <div class="box box-danger">
                                <div class="box-header">
                                    <h3 class="box-title">Pasi pentru indeplinirea lucrarii: </h3>
                                </div>
                                <div class="box-body">
                                    <ol>
                                        <li>Introduceti doua numere prime "p" si "q".</li>
                                        <li>Calculati modulo (<i>r = pq</i>) si Euler totient (<i> x =(p-1)(q-1) </i>) </li>
                                        <li>Determinati o cheie publica(<i>un numar  de la 2 pina la x , <a href="http://en.wikipedia.org/wiki/Coprime_integers">coprim</a> cu x </i>)</li>
                                        <li>Determinati cheie privata, corespunzatoare cu cheia publica, fiind <a href="http://en.wikipedia.org/wiki/Modular_multiplicative_inverse">multiplicativ inversa</a> modulo x  a cheii publice selectate anterior </li>
                                        <li>Introduceti cheia publica si private pentru sender.</li>
                                        <li>Repetati pasii 3 si 4 pentru a primi o alta perche de chei</li>
                                        <li>Introduceti cheia publica si private pentru receiver.</li>
                                    </ol>
                                </div><!-- /.box-body -->
                            </div><!-- /.box -->
                        </div><!--/.col -->

                    </div>   <!-- /.row -->

                </section><!-- /.content -->
            </aside><!-- /.right-side -->
        </div><!-- ./wrapper -->

        <!-- jQuery 2.0.2 -->
        <script src="../js/jquery.min.js"></script>
        <!-- jQuery UI 1.10.3 -->
        <script src="../js/jquery-ui-1.10.3.min.js" type="text/javascript"></script>
        <!-- Bootstrap -->
        <script src="../js/bootstrap.min.js" type="text/javascript"></script>
        <!-- iCheck -->
        <script src="../js/plugins/iCheck/icheck.min.js" type="text/javascript"></script>
        <!-- AdminLTE App -->
        <script src="../js/AdminLTE/app.js" type="text/javascript"></script>
        <!-- Ion Slider -->
        <script src="../js/plugins/ionslider/ion.rangeSlider.min.js" type="text/javascript"></script>

        <script type="text/javascript">
            $(function() {

            // Euler totient function
            function totient(p, q) {
                return (p - 1) * (q -1)
            }

            // Greates common divisor
            function gcd(a, b) {
                while(b != 0) {
                    t = b
                    b = a % b
                    a = t
                }
                return a
            }

            // Extended greatest common divisor
            function egcd(a, b) {
                if (a == 0) {
                    return [b, 0 ,1]
                }
                else {
                    list = egcd(b % a, a)
                    g = list[0]
                    y = list[1]
                    x = list[2]
                    return [g, x - Math.floor(b/a) * y, y]
                }
            }

            //Modular multiplicative inverse
            function mod_inv(a, m) {
                list = egcd(a, m)
                if (list[0] != 1) {
                    return null // modular inverse doesn't exist
                }
                else {
                    inv = list[1]
                    if(inv<0) { inv+=m }
                    return inv
                }
            }
            //Exponentiation by squaring
            function power(x, n) {
                if (n == 0) {
                    return 1
                }
                else if (n == 1) {
                    return x
                }
                else if ((n % 2) == 1) {
                    return power(x*x, (n - 1)/2)
                }
                else {
                    return power(x*x, n/2)
                }
            }

            function is_coprime(a, b) {
                if (gcd(a,b) == 1) {
                    return true
                }
                else {
                    return false
                }
            }

            function choose_pub_key(totient) {
                while(true) {
                    pub = Math.floor((Math.random() * (totient - 1))+1)
                    if (is_coprime(pub, totient)) {
                        return pub
                    }
                }
            }

            function choose_private_key(totient, pub_key) {
                return mod_inv(pub_key, totient)
            }

            function pow_mod(block, key, modulus) {
                mod = modulus
                s = 1
                k = key
                c = block
                while(k != 0) {
                    flag = 0
                    if (k%2 == 1) {
                        s =(s*c) % mod
                        k = (k-1)/2
                        c = (c*c) % mod
                        flag = 1
                    }
                    else { k = k/2 }
                    if (!flag) {
                        c = (c*c) % mod
                    }
                }
                return s
            }

            // 100 % primality
            // returns 0 if prime
            // prime factor if composite

            function is_prime(n) {
                if (n == 2) return 0
                if (n % 2==0) return 2
                var isprime = true
                var max_prime = Math.floor(Math.sqrt(n) + 1)

                for (var i=3; i <= max_prime; i += 2) {
                    if(!(n % i))
                    {
                        isprime = false
                        break
                    }
                }

                if (isprime) return 0
                else return i
            }
            //TODO Miller-rabin primality test
            function is_prob_prime(n, k) {
                d = n - 1
                s = 0
                while(d % 2 == 0)
                {
                    d /= 2
                    s += 1
                }
                while(k >= 0) {
                    a = Math.floor(Math.random() * (n - 4)) + 2
                    x = pow_mod(a, d, n) //pow(a,s) % n
                    console.log('x: ' + x+ ' s '+s)
                    if(x != 1 && x != n-1) {
                        i = 0
                        while(i<=s) {
                            x = pow_mod(x, 2, n)
                            if (x == 1) {
                                console.log(x+' h')
                                return false //is composite
                            }
                            else if (x == (n -1)){
                                console.log('h  x:' + x)
                                a = 0
                                break
                            }
                            console.log('i '+i+' x '+x+' a '+a)
                            i += 1
                        }
                        if (a!=0) { console.log('a:'+ a); return false}
                        k -= 1
                    }
                }
                return true
            }

            //function for encryption
            function encrypt(message, key1, key2, modulo) {
                if (typeof(message) == 'string') {
                    msg = to_list(message)
                }
                else {
                    msg = message
                }
                intermediate = []
                result = []
                for(var i=0; i<msg.length; i++) {
                    intermediate.push(pow_mod(msg[i], key1, modulo))
                }
                result = []
                for(var i=0; i<intermediate.length; i++) {
                    result.push(pow_mod(intermediate[i], key2, modulo))
                }
                return result
            }

            function to_list(str) {
                list = []
                for(var i=0; i<str.length; i++) {
                    list.push(str.charCodeAt(i))
                }
                return list
            }

            function to_str(list) {
                msg = ''
                for(var i=0; i<list.length; i++) {
                    msg += String.fromCharCode(list[i])
                }
                return msg
            }

            function isPrime(n) {
             if (isNaN(n) || !isFinite(n) || n%1 || n<2) return false;
             var m=Math.sqrt(n);
             for (var i=2;i<=m;i++) if (n%i==0) return false;
             return true;
            }

            function isValidPubKey(candidate, totient) {
                if (candidate<2 || candidate>totient || gcd(candidate, totient)!=1) return false;
                return true;
            }
            function isValidPrivKey(candidate, pub_key, totient) {
                if (candidate*pub_key % totient == 1) return true;
                return false;
            }

              var n, public_key, private_key, totient_val, p, q;

               $("#p, #q").bind('keyup change',function() {
                    number_validation($(this));
                    set_R();
               });

               $("#a_public_key").bind('keyup change',function() {
                    p = parseInt($('#p').val());
                    q = parseInt($('#q').val());
                    totient_val = totient(p,q);
                    public_key_validation($(this), totient_val);
               });

               $("#a_private_key").bind('keyup change',function() {
                    var a_public = parseInt($('#a_public_key').val());

                    p = parseInt($('#p').val());
                    q = parseInt($('#q').val());
                    totient_val = totient(p,q);

                    private_key_validation($(this), a_public, totient_val);
               });

                $('#encode').on('click', function(e){
                    e.preventDefault();

                    p = parseInt($('#p').val()),
                    q = parseInt($('#q').val()),
                    n = p*q;

                    var text = $('#input_text').val();

                    if(!text.trim()){ // empty text
                        validate_input($('#input_text'), false);
                    } else {
                        var a_public_key = parseInt($('#a_public_key').val()),
                              b_private_key = parseInt($('#b_private_key').val());

                         if(isNaN(a_public_key) && isNaN(b_private_key)){
                            add_key_error();
                        } else {
                            var crypto = encrypt(text, a_public_key, b_private_key, n);
                            $("#crypto").val(crypto);
                            validate_input($('#input_text'), true);
                            $("#input_text").val("");
                            remove_key_error();
                        }
                    }
                });

                $('#decode').on('click', function(e){
                    e.preventDefault();

                    var a_private_key = parseInt($('#a_private_key').val()),
                          b_public_key = parseInt($('#b_public_key').val()),
                          cryptograma = $("#crypto").val();

                   // check for private key
                   if(isNaN(a_private_key) && isNaN(b_public_key)){
                       add_key_error();
                   } else {
                        remove_key_error();
                         // check for text input
                        if(!cryptograma.trim()){
                             validate_input($('#crypto'), false);
                        } else {
                            var original = encrypt(cryptograma.split(","), b_public_key, a_private_key,  n);
                            $('#input_text').val(to_str(original));
                            validate_input($('#crypto'), true);
                        }
                   }
                });

            var number_validation = function(selector){
              remove_number_error();

                var value = parseInt(selector.val()),
                      form_group = selector.closest('.form-group');
                      label_suc = "<label class='control-label'><i class='fa fa-check'></i>"
                      label_err = "<label class='control-label'><i class='fa fa-times-circle-o'></i>"
                if(isNaN(value)){
                      form_group.children('.control-label').remove();
                      form_group.removeClass('has-success');
                      form_group.addClass('has-error').append(label_err+' Nu este numar valid.'+"</label>");
                } else {
                      if(value < 0){
                         form_group.children('.control-label').remove();
                         form_group.removeClass('has-success');
                         form_group.addClass('has-error').append(label_err+' Numarul este negativ.'+"</label>");
                     } else {
                         if(isPrime(value)){
                            form_group.removeClass('has-error');
                            form_group.children('.control-label').remove();
                            form_group.addClass("has-success").append(label_suc+" Numar valid."+"</label>");
                        } else {
                            form_group.removeClass('has-success');
                            form_group.children('.control-label').remove();
                            form_group.addClass("has-error").append(label_err+" Nu este prim."+"</label>");
                        }
                    }
                }
            }

            var public_key_validation = function(selector, totient){
              remove_number_error();

                var value = parseInt(selector.val()),
                      form_group = selector.closest('.form-group');
                      label_suc = "<label class='control-label'><i class='fa fa-check'></i>"
                      label_err = "<label class='control-label'><i class='fa fa-times-circle-o'></i>"
                if(isNaN(value)){
                      form_group.children('.control-label').remove();
                      form_group.removeClass('has-success');
                      form_group.addClass('has-error').append(label_err+' Nu este cheie valida.'+"</label>");
                } else {
                      if(value < 0){
                         form_group.children('.control-label').remove();
                         form_group.removeClass('has-success');
                         form_group.addClass('has-error').append(label_err+' Cheia este negativ.'+"</label>");
                     } else {
                         if(isValidPubKey(value, totient)){
                            form_group.removeClass('has-error');
                            form_group.children('.control-label').remove();
                            form_group.addClass("has-success").append(label_suc+" Cheie valida."+"</label>");
                        } else {
                            form_group.removeClass('has-success');
                            form_group.children('.control-label').remove();
                            form_group.addClass("has-error").append(label_err+" Nu este valid."+"</label>");
                        }
                    }
                }
            }

            var private_key_validation = function(selector, public_key, totient){
                // error case
              remove_number_error();

                var value = parseInt(selector.val()),
                      form_group = selector.closest('.form-group');
                      label_suc = "<label class='control-label'><i class='fa fa-check'></i>"
                      label_err = "<label class='control-label'><i class='fa fa-times-circle-o'></i>"
                if(isNaN(value)){
                      form_group.children('.control-label').remove();
                      form_group.removeClass('has-success');
                      form_group.addClass('has-error').append(label_err+' Nu este cheie valida.'+"</label>");
                } else {
                      if(value < 0){
                         form_group.children('.control-label').remove();
                         form_group.removeClass('has-success');
                         form_group.addClass('has-error').append(label_err+' Cheia este negativ.'+"</label>");
                     } else {
                         if(isValidPrivKey(value, public_key, totient)){
                            form_group.removeClass('has-error');
                            form_group.children('.control-label').remove();
                            form_group.addClass("has-success").append(label_suc+" Cheie valida."+"</label>");
                        } else {
                            form_group.removeClass('has-success');
                            form_group.children('.control-label').remove();
                            form_group.addClass("has-error").append(label_err+" Nu este valid."+"</label>");
                        }
                    }
                }
            }

            var set_R = function(){
               var p = parseInt($('#p').val()),
                      q = parseInt($('#q').val()),
                      n = 0;

                 if(!isNaN(p) && !isNaN(q)){
                    n = p*q;
                  }
                  $("#r").val(n);
            }

            var add_number_error = function(){
                var form_group = $('.numbers_form'),
                      label_err = "<label class='pull-right control-label'><i class='fa fa-times-circle-o'></i>";

                form_group.children('.control-label').remove();
                form_group.removeClass('has-success');
                form_group.addClass('has-error').append(label_err+' Introduceti numere valide.'+"</label>");
            }

            var remove_number_error = function(){
                $('.numbers').children('.control-label').remove();
                $('.numbers').removeClass('has-error');
            }

            var add_key_error = function(){
                var form_group = $('.private_key_form'),
                      label_err = "<label class='pull-right control-label'><i class='fa fa-times-circle-o'></i>";

                form_group.children('.control-label').remove();
                form_group.removeClass('has-success');
                form_group.addClass('has-error').append(label_err+' Introduceti kei valide.'+"</label>");
            }

            var remove_key_error = function(){
                $('.private_key_form').children('.control-label').remove();
                $('.private_key_form').removeClass('has-error');
            }

            var set_generated_value = function(pub, priv){
                $("#a_public_key").val(pub);
                $("#a_private_key").val(priv);
                $("#a_public_key, #a_private_key").closest('.form-group').addClass('has-warning');
            }

            var validate_input = function(selector, cond){
                var form_group = selector.closest('.form-group'),
                      label_err = "<label class='pull-right control-label'><i class='fa fa-times-circle-o'></i>";

                  if(!cond){
                     form_group.children('.control-label').remove();
                     form_group.removeClass('has-success');
                     form_group.addClass('has-error').append(label_err+' Introduceti text.'+"</label>");
                 } else {
                    form_group.removeClass('has-error');
                    form_group.children('.control-label').remove();
                }
            }

            });
        </script>

    </body>
</html>
